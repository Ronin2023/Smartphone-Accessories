<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Database Connection Error Redirect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .success {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Database Connection Error Redirect Test</h1>
        
        <div class="success">
            <h3>‚úÖ Fix Applied Successfully!</h3>
            <p>The database connection handling has been modified to:</p>
            <ul>
                <li><strong>Always redirect to connection-error.php</strong> for ALL request types</li>
                <li><strong>No more JSON responses</strong> for AJAX database connection errors</li>
                <li><strong>Consistent user experience</strong> regardless of form submission method</li>
            </ul>
        </div>

        <div class="info">
            <h3>üéØ Expected Behavior:</h3>
            <p>When database connection fails:</p>
            <ul>
                <li><strong>AJAX Form Submissions:</strong> Should redirect to connection-error.php (NO JSON shown)</li>
                <li><strong>Regular Form Submissions:</strong> Should redirect to connection-error.php</li>
                <li><strong>Direct API Access:</strong> Should redirect to connection-error.php</li>
                <li><strong>All Cases:</strong> User sees custom error page, never raw JSON</li>
            </ul>
        </div>

        <h3>üß™ Test Methods:</h3>
        
        <div style="margin: 20px 0;">
            <h4>1. AJAX Form Test (Contact Form)</h4>
            <p>Test the contact form with AJAX submission:</p>
            <a href="contact.html" class="btn">Test Contact Form</a>
            <p><small>Submit the form - should redirect to connection-error.php if database is down</small></p>
        </div>

        <div style="margin: 20px 0;">
            <h4>2. Regular Form Test</h4>
            <p>Test regular form submission (non-AJAX):</p>
            <a href="test-form-submission.html" class="btn">Test Regular Form</a>
            <p><small>Submit the form - should redirect to connection-error.php if database is down</small></p>
        </div>

        <div style="margin: 20px 0;">
            <h4>3. Direct API Test</h4>
            <p>Test the API endpoint directly:</p>
            <button class="btn btn-danger" onclick="testApiDirect()">Test API Direct Access</button>
            <p><small>This will make an AJAX call to the API - should redirect instead of showing JSON</small></p>
        </div>

        <div style="margin: 20px 0;">
            <h4>4. Manual Error Page Test</h4>
            <p>Test the connection error page manually:</p>
            <button class="btn" onclick="testErrorPage()">View Connection Error Page</button>
            <p><small>This will redirect to connection-error.php with test data</small></p>
        </div>

        <div class="info">
            <h3>üìã Testing Instructions:</h3>
            <ol>
                <li><strong>Ensure database is stopped</strong> (MySQL/MariaDB service)</li>
                <li><strong>Test each method above</strong></li>
                <li><strong>Expected Result:</strong> All should redirect to connection-error.php</li>
                <li><strong>No JSON should be visible</strong> to the user in any scenario</li>
            </ol>
        </div>
    </div>

    <script>
        async function testApiDirect() {
            try {
                console.log('Testing API direct access...');
                
                const formData = new FormData();
                formData.append('name', 'API Test User');
                formData.append('email', 'apitest@example.com');
                formData.append('subject', 'API Direct Test');
                formData.append('message', 'Testing direct API access for database error handling');
                formData.append('priority', 'medium');
                
                // This should redirect to connection-error.php instead of returning JSON
                const response = await fetch('api/submit_contact.php', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                // If we get here, something unexpected happened
                console.log('Unexpected response:', response);
                alert('‚ùå Test Failed: Got response instead of redirect\nStatus: ' + response.status + '\nThis should have redirected to connection-error.php');
                
            } catch (error) {
                console.log('Expected behavior - request was redirected or failed:', error);
                alert('‚úÖ Expected Behavior: Request was redirected or failed\nThis indicates the redirect is working!\nError: ' + error.message);
            }
        }

        function testErrorPage() {
            // Store test error information
            const errorInfo = {
                type: 'database',
                message: 'Manual test - simulated database connection error',
                timestamp: Date.now(),
                referring_page: window.location.href
            };
            
            sessionStorage.setItem('connectionErrorInfo', JSON.stringify(errorInfo));
            
            alert('üîÑ Redirecting to connection error page...\n\nThis will test the error page display with stored error information.');
            
            setTimeout(() => {
                window.location.href = 'connection-error.php';
            }, 1000);
        }

        // Add status check
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Database Connection Error Redirect Test');
            console.log('‚úÖ Fix applied: All database errors now redirect to connection-error.php');
            console.log('‚ùå No more JSON responses for database connection errors');
            console.log('üéØ Test all methods to verify the fix works');
        });
    </script>
</body>
</html>